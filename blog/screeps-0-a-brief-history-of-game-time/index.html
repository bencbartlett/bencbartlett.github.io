<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Screeps #0: A Brief History of Game.time | Ben Bartlett</title> <meta name="author" content="Ben Bartlett"> <meta name="description" content=""> <meta name="keywords" content="nanophotonics, quantum computing, quantum information, quantum optics, machine learning, photonic computing, optical computing, quantum optics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/icon_small.png?01d7031506c34cc363a931ca8ca98684"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://bencbartlett.github.io/blog/screeps-0-a-brief-history-of-game-time/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Ben </span><span class="font-weight-bold">Bartlett</span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/software/">Software</a> </li> <li class="nav-item "> <a class="nav-link" href="/math-animations/">Math Animations</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Screeps #0: A Brief History of Game.time</h1> <p class="post-meta">December 19, 2017</p> <p class="post-tags"> <a href="/blog/2017"> <i class="fas fa-calendar fa-sm"></i> 2017 </a>   ·   <a href="/blog/tag/screeps"> <i class="fas fa-hashtag fa-sm"></i> screeps</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="screeps-like-starcraft-at-0001-speed">Screeps: like Starcraft at 0.001% speed</h2> <p>If you knew me in early 2017, you probably knew I became entirely too invested writing an AI for the programming strategy game <a href="https://screeps.com/" rel="external nofollow noopener" target="_blank">Screeps</a>. (If you didn’t know me in early 2017, it’s probably because I was hiding in my room programming.)</p> <p>Like most RTS games, the core objective of Screeps is to expand your territory and defend against other players. However, unlike most RTS games, you cannot actively control your units; you must instead write code to govern their behavior using JavaScript (or a transpiled language). The units run in real-time even when you aren’t actively playing the game, and the game progresses on the scale of weeks or months, so the more you can automate, the better.</p> <p>Since I started playing the game - exactly 11 months ago as of today - I’ve created a Screeps AI, with some ~50,000 additions to the GitHub repository, which I dubbed <a href="https://github.com/bencbartlett/overmind" rel="external nofollow noopener" target="_blank">Overmind</a> (much of the code is vaguely Starcraft-themed). I stopped playing the game for a few months over the last summer, but I was recently surprised to find my code was still running like a well-oiled machine on the public servers, so I decided to pick the game back up again. There’s a lot of changes and improvements I’d like to make, and I’ve enjoyed reading <a href="https://arcath.net/category/screeps/" rel="external nofollow noopener" target="_blank">other people’s blogs</a> about their evolving Screeps AI’s, so I’ve decided to start my own.</p> <h2 id="overmind-a-brief-history">Overmind: a brief history</h2> <p>Any large programming project has an iterative write-deploy-rewrite rhythm to it, but some rewrites are larger than others. I can break down the history of my Screeps AI to five stages, separated by the largest rewrites:</p> <ol> <li> <a href="https://github.com/bencbartlett/Overmind/tree/1c2c0af0d9d9a9d5669ef9c9a62aca53d3e28be0" rel="external nofollow noopener" target="_blank">My first AI</a> was effectively a state machine hastily written in Javascript to bootstrap my entry into the world of Screeps. It had a few simple roles, like harvesters and haulers, and didn’t have much in the way of collective or inter-creep organization.</li> <li> <a href="https://github.com/bencbartlett/Overmind/tree/9e525cb7109f0a4b0704613f0c27e46df1463cb4" rel="external nofollow noopener" target="_blank">The second version</a> (first rewrite) refactored the roles into extensible classes and added a collective <a href="https://github.com/bencbartlett/Overmind/blob/9e525cb7109f0a4b0704613f0c27e46df1463cb4/Brain_Room.js" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">RoomBrain</code></a> object to prioritize tasks and assign them to creeps in the most efficient order possible, functioning a little bit like a greedy scheduling algorithm dispatching processes in an OS. It also added <a href="https://github.com/bencbartlett/Overmind/blob/9e525cb7109f0a4b0704613f0c27e46df1463cb4/Task.js" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">Task</code></a> objects to more concisely tell creeps what to do and when to stop doing it, and it added the first instances of behavior modifications and military capabilities, with <a href="https://github.com/bencbartlett/Overmind/blob/9e525cb7109f0a4b0704613f0c27e46df1463cb4/flag_millitary.js" rel="external nofollow noopener" target="_blank">flags</a> functioning as injectable code snippets to modify the standard behavior.</li> <li> <a href="https://github.com/bencbartlett/Overmind/tree/dfe55cd414624ad8b1b17e42c5a34454d972120b" rel="external nofollow noopener" target="_blank">In version 3</a>, I rewrote the entire AI using TypeScript, after my ballooning codebase began to become riddled with runtime errors which could easily be fixed by a strong type system. I found structNullChecks to be especially valuable, since many of the errors I was getting were when I was unsafely trying to access a nonexistent object. Migrating to TypeScript changed the general flavor of much of my code, and my AI became super object-oriented in the next rewrite.</li> <li> <a href="https://github.com/bencbartlett/Overmind/tree/fe44a3b93602eb1f6ee7e26bf0c9e7ad8e632874/src" rel="external nofollow noopener" target="_blank">The fourth version</a> of the AI is where I left off over last summer. As I was expanding quickly, I needed a stronger and more flexible way to deal with objects across multiple rooms. So, I introduced <a href="https://github.com/bencbartlett/Overmind/blob/fe44a3b93602eb1f6ee7e26bf0c9e7ad8e632874/src/Colony.ts" rel="external nofollow noopener" target="_blank">Colonies</a> to group together outposts operated by a single owned room and <a href="https://github.com/bencbartlett/Overmind/wiki/Design:-Hive-Clusters" rel="external nofollow noopener" target="_blank">Hive Clusters</a> to group creeps and structures with a similar purpose (for example, spawning structures in a <a href="https://github.com/bencbartlett/Overmind/blob/fe44a3b93602eb1f6ee7e26bf0c9e7ad8e632874/src/hiveClusters/Hatchery.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">Hatchery</code></a>). Although colonies greatly simplified the process of programming just about everything (instead of finding sources across multiple rooms filtered rooms, you can just say colony.sources), it added significant CPU overhead, so I added a more advanced <a href="https://github.com/bencbartlett/Overmind/blob/fe44a3b93602eb1f6ee7e26bf0c9e7ad8e632874/src/preprocessing.ts" rel="external nofollow noopener" target="_blank">preprocessing</a> system to avoid doing duplicate searches in the same tick. I also added <a href="https://github.com/bencbartlett/Overmind/blob/fe44a3b93602eb1f6ee7e26bf0c9e7ad8e632874/src/objectives/objectives.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">Objective</code>s</a>, which dispense tasks when assigned to a creep. To more finely control which creeps can do what actions, allowing for dedicated creeps to attend to certain clusters, I added <a href="https://github.com/bencbartlett/Overmind/blob/fe44a3b93602eb1f6ee7e26bf0c9e7ad8e632874/src/objectives/ObjectiveGroup.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">ObjectiveGroup</code>s</a> and <a href="https://github.com/bencbartlett/Overmind/blob/fe44a3b93602eb1f6ee7e26bf0c9e7ad8e632874/src/resourceRequests/ResourceRequestGroup.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">ResourceRequestGroup</code>s</a>, which allow you to group together some subset of the operations that need to be done within a colony, so that only certain creeps will access them. (For example, only the hatchery attendants should refill the hatchery extensions.)</li> <li>In <a href="https://github.com/bencbartlett/Overmind/tree/a5637d5cad1542ca30844d13be9fc233b64eec36" rel="external nofollow noopener" target="_blank">the current version</a> of the AI, I haven’t made any radical changes yet, but I’ve began experimenting with some new features, such as <a href="https://github.com/bencbartlett/Overmind/tree/a5637d5cad1542ca30844d13be9fc233b64eec36/src/directives" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">Directive</code>s</a>, which represent a more advanced method of behavior modification, and <a href="https://github.com/bencbartlett/Overmind/tree/a5637d5cad1542ca30844d13be9fc233b64eec36/src/roomPlanner" rel="external nofollow noopener" target="_blank">automatic room planning</a>. Slowly but surely, I think I’m beginning to decide on a concrete direction to take the next rewrite.</li> </ol> <h2 id="the-good-the-bad-and-the-ugly">The good, the bad, and the ugly</h2> <p>Over the last few weeks, I’ve spent a lot of time thinking about what I like and what I don’t like in my Screeps AI. Here’s a few of the things it does well:</p> <ul> <li>Colonies effectively abstractify away distinctions in rooms, making it very easy to program multi-room operations, such as container mining and hauling.</li> <li>Hive Clusters are an intuitive way to program related functionalities that offers a lot of fine control over the behavior of the creeps attending to the cluster. They are also good at designating specific functionalities for specific structures. For example, the Hatchery link, which always requests energy, is just <code class="language-plaintext highlighter-rouge">colony.hatchery.link</code>, and the Command Center link is <code class="language-plaintext highlighter-rouge">colony.commandCenter.link</code>, which is managed by <code class="language-plaintext highlighter-rouge">colony.commandCenter.manager</code>.</li> <li>Tasks are generally pretty good and minimize much of the decision-tree overhead that many AI’s feature, since a creep only needs to request a new task when its old one becomes invalid. While they are good at most actions, they aren’t the most flexible design, so they are bad for more complex scenarios where multiple actions should be executed, such as healing and attacking at the same time while trying to maintain a certain range. I’ve added a few things to make them more process-like, including forking tasks and reverting to parent tasks, but they’re probably only good for about 80% of use cases.</li> <li>Directives are still pretty simple and limited in scope, but I think they are a pretty promising way to implement conditional behavior modification.</li> <li>My room planning system is gonna be really cool when I finish it! (More about that in a future post.)</li> </ul> <p>Now for the things I don’t like:</p> <ul> <li>Between Roles and Hive Clusters, I’ve developed two very different programming paradigms for controlling creep actions. I generally prefer the latter, since the former can be pretty inflexible when coordinating multiple roles, but it’s obviously not suitable for all cases. However, I think there needs to be a single unified method for programming creep actions that combines the best of both paradigms.</li> <li>Because my AI instantiates so many book-keeping objects with Colonies and Hive Clusters, the initialization phase is really sensitive to the order in which you call things, since all of these objects can be pretty tightly interlinked.</li> <li>My AI sucks at low RCL, especially if I don’t have a grown colony to incubate the new one. This is mainly because I haven’t respawned since the very first rewrite of my AI, so I haven’t put much thought into how low-level code works. However, it’s also caused by bugs in the next bullet point.</li> <li>I like the idea of ObjectiveGroups, but I think the Objectives are an overly-complicated and buggy system. The way that the ObjectiveGroup dispenses tasks doesn’t offer very much intuition or control over what’s going on, and since objectives and tasks are closely related but different, it is possible for a creep to lose the task but still think it’s associated with the corresponding objective. This can cause fatal bugs at low RCL.</li> <li>My spawning code is pretty clean, but it gets called in many different locations. Hive clusters request creeps, Directives conditionally request creeps, and the colony <code class="language-plaintext highlighter-rouge">Overlord</code> randomly requests the remaining creeps. I want to consolidate the spawning requests to a single process.</li> <li>I’ve spent so much time writing and rewriting the core framework of how my AI functions that I haven’t added entire sets of features to it. I’m almost done with room planning, but I still have very minimal military code and little to no trading or mineral processing capabilities. I’m hoping that this next rewrite will begin to set the final paradigm of how things are done in Overmind and that I can progress to adding new features to finish the AI.</li> </ul> <h2 id="a-rewrite-and-a-respawn">A rewrite and a respawn</h2> <p>Now that my first term of grad school is over, I finally have some time on my hands to make some major changes. I have a relatively solid idea of the general direction I’d like to take things, but I won’t give away too much:</p> <ul> <li>I think my first priority is rewriting the way I control creeps. I like how Hive Clusters control them, so I think I’m going to extract that creep control method along with all of the spawning requests scattered around, which follow a very similar pattern to each other, and put then in a new class: <code class="language-plaintext highlighter-rouge">Overseer</code>. I’m still figuring out exactly how this will work, but my thought is to tether creep control and spawning requests to a process that needs to be done, such as building construction sites, remote mining, or even creep-less processes such as managing link transfers. I want to make Overseers integrate cleanly with Hive Clusters but also make them independent so that structure-less or conditional operations, such as guarding a room from invaders, can be programmed using Overseers too.</li> <li>Currently, I have two main phases in each tick: <code class="language-plaintext highlighter-rouge">init()</code> and <code class="language-plaintext highlighter-rouge">run()</code>. I want to refactor the AI initialization by adding a <code class="language-plaintext highlighter-rouge">build()</code> phase (which I’ve already started working on), so that it doesn’t matter which order you instantiate components in.</li> <li>Instantiating all of the book-keeping objects can be pretty CPU intensive. I recently read BonzAI’s <a href="https://github.com/bonzaiferroni/bonzAI/wiki/A-new-phase-for-bonzAI:-update()" rel="external nofollow noopener" target="_blank">post</a> where he’s started creating global objects that last between ticks. I think this might be even more useful in my case, since I basically rebuild the entire game environment with every tick. I’ll probably split <code class="language-plaintext highlighter-rouge">build()</code> into <code class="language-plaintext highlighter-rouge">build()</code> and <code class="language-plaintext highlighter-rouge">rebuild()</code>. The former will get called once per node every global reset, and the latter will conditionally re-cache certain properties of objects.</li> </ul> <p>I’ve made a ton of changes over the last few weeks preparing for this rewrite, and not all of them have gone over smoothly. I’ve introduced several game-breaking bugs that have cause colony-wide blackouts, and now that I’ve started doing most of my testing on a private server, I’ve started to neglect my public server code. I’ve also become kind of lonely with the <a href="https://blog.screeps.com/2017/08/shards/" rel="external nofollow noopener" target="_blank">release of shards</a>, since a good portion of shard0 has moved to the faster and more densely-packed shard1 and shard2. After I finish this rewrite, I think I’ll try my luck and respawn in one of the new shards with my shiny new Screeps AI.</p> </div> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © Copyright 2023 Ben Bartlett. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-2CXQQV4W2T"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2CXQQV4W2T");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>