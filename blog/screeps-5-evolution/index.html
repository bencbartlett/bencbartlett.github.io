<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Screeps #5: Evolution | Ben Bartlett</title> <meta name="author" content="Ben Bartlett"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://bencbartlett.github.io/blog/screeps-5-evolution/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Ben </span><span class="font-weight-bold">Bartlett</span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/software/">Software</a> </li> <li class="nav-item "> <a class="nav-link" href="/math-animations/">Math Animations</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Screeps #5: Evolution</h1> <p class="post-meta">August 11, 2018</p> <p class="post-tags"> <a href="/blog/2018"> <i class="fas fa-calendar fa-sm"></i> 2018 </a>   ·   <a href="/blog/tag/screeps"> <i class="fas fa-hashtag fa-sm"></i> screeps</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Most of my previous posts have focused on a single aspect of my bot development. This is not one of those posts.</p> <p>Over the last few months since my last post, Overmind has evolved considerably as I’ve added a ton of new features to my bot (read: <a href="https://github.com/bencbartlett/Overmind/compare/v0.2.1...HEAD" rel="external nofollow noopener" target="_blank">22k</a> new lines of code). While none of them were individually as technically challenging or original as the <a href="https://bencbartlett.wordpress.com/2018/03/28/screeps-4-hauling-is-np-hard/" rel="external nofollow noopener" target="_blank">logistics system</a> to warrant their own post, I figured I’d make this post a show-and-tell session for some of the new features I’ve been working on.</p> <h2 id="bunkers">Bunkers</h2> <p>The classic “box and flower” layout (like the one in <a href="https://bencbartlett.wordpress.com/2018/02/06/screeps-2-interior-design/" rel="external nofollow noopener" target="_blank">this post</a>) was designed primarily with logistics in mind. Having a physically separated “hatchery” (spawning block) and “command center” (storage block) allows for you to place the central dropoff point for resources closer to the ideal location that minimizes total path length to nearby sources without being constrained by the full bulk of the base. This design served this purpose well, but it suffered from two key defensive flaws: the tower spread reduces total tower damage at siege points, and the spawning rate can be limited by the hatchery link bandwidth.</p> <p>Enter bunkers. Bunker <a href="https://github.com/bencbartlett/Overmind/tree/master/assets/basePlanner" rel="external nofollow noopener" target="_blank">assets</a> have been sitting in the AI for a long time, but living next to everyone’s friendly neighborhood tiger forced me to prioritize their development one he figured out how to exploit the flaws of my previous layout. The final design went through a lot of iterations, but I’m quite happy with how it turned out. Here’s an annotated image of a fully-developed base:</p> <p><img src="/assets/img/screen-shot-2018-08-07-at-7-12-14-pm.png" alt="Screen Shot 2018-08-07 at 7.12.14 PM" class="img-fluid rounded z-depth-0"></p> <p>Each bunker has three permanent attendants: a manager and two queens. Managers are stationary 16-CARRY 0-MOVE creeps that sit in the center of each bunker, connecting the storage, terminal, central link, and RCL8 structures. Queens are general-purpose base attendants which fill and empty structures requesting any type of resource.</p> <p>Managers are relatively unchanged in bunker colonies and are run by the same overlord as in the classic layout. The most notable difference is that managers for RCL8 bunkers are immobile (a design choice enabled by some <a href="https://github.com/bencbartlett/Overmind/blob/0ced04b501a74215124c1db2773a379563e8fa6f/src/hiveClusters/hatchery.ts#L205" rel="external nofollow noopener" target="_blank">improvements</a> to my creep spawning code), spending their entire life at the central “anchor” tile of the bunker. If there are ramparts within range 3 of the anchor below their target hits, the manager will be spawned with 32 WORK parts and will fortify the ramparts when it is idling.</p> <p>Although they share the same role name as the hatchery attendants in the classic layout, queens are run by a <a href="https://github.com/bencbartlett/Overmind/blob/master/src/overlords/core/queen_bunker.ts" rel="external nofollow noopener" target="_blank">separate overlord</a> in bunker-type colonies, which features a large number of hard-coded optimizations specific to the bunker layout. Each “quadrant” (group of contiguous buildings) in the bunker has a <a href="https://github.com/bencbartlett/Overmind/blob/fcc299ad7f503716fa7e5dc786ae04c01ab799ab/src/roomPlanner/layouts/bunker.ts#L501" rel="external nofollow noopener" target="_blank">hard-coded fill order</a> (illustrated in the above image) to minimize walking distance, and each queen gets assigned two quadrants and a “battery” (the top and bottom containers in the bunker, which serve as an energy buffer). To further reduce the CPU cost, rather than executing the fill logic after every transfer, queens are assigned a single <a href="https://github.com/bencbartlett/Overmind/blob/0ced04b501a74215124c1db2773a379563e8fa6f/src/tasks/Tasks.ts#L31" rel="external nofollow noopener" target="_blank">chained</a> task object which represents <a href="https://github.com/bencbartlett/Overmind/blob/90d05e8d16261ac371af8c3622331a6797c7dd9c/src/overlords/core/queen_bunker.ts#L105" rel="external nofollow noopener" target="_blank">an entire “manifest”</a> of supply operations which can be done with the creep’s carry capacity. (The chained task also sets the <a href="https://github.com/bencbartlett/Overmind/blob/0ced04b501a74215124c1db2773a379563e8fa6f/src/tasks/Task.ts#L219" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">nextPos</code></a> property of each subtask to ensure that the queen promptly moves to her next destination so no ticks are wasted idling between tasks.)</p> <p>The task-chaining logic and the generality of the logistics system makes handling requests for multiple resources in a single carry quite straightforward. So in bunker-type colonies, queens are double-purposed as lab attendants (a job handled by the manager in the classic layout). A nice feature of my bunker layout is that every spawn has a lab adjacent to it, meaning that <em>creeps can be boosted while they are still spawning!</em> This helps to reduce congestion within the base and maximizes the boosted lifetime of the creeps.</p> <p>Another quirk of my new layout is that at RCL8, only 51 of the available 60 extensions are built in the main bunker. Having only 51 extensions significantly improves the compactness of the design while still allowing for one exit on each side. The remaining extensions will be placed next to “dropoff” links in the room (links not claimed by a miningSite or upgradeSite) and will be filled by idle transporters. In the event of a siege where the links and external extensions could easily be destroyed, 51 extensions poses almost no limitation to the types of defensive creeps which can be spawned, as the colony could still spawn the most expensive healer creeps with 38-HEAL, 12-MOVE bodies.</p> <h2 id="traffic-management">Traffic management</h2> <p>If bunkers’ greatest strength is the high tower damage resulting from their compactness, their greatest weakness is the congestion resulting from their compactness. Making bunkers work required some massive improvement to my traffic management code and resulted in a completely new <a href="https://github.com/bencbartlett/Overmind/blob/0ced04b501a74215124c1db2773a379563e8fa6f/src/movement/Movement.ts" rel="external nofollow noopener" target="_blank">movement library</a>. (Previously, I used <a href="https://github.com/bonzaiferroni/Traveler" rel="external nofollow noopener" target="_blank">Traveler</a>; my new library uses some of the same code under the hood but adds a number of new features and integrates more tightly with the Overmind framework.)</p> <p>All creeps in my AI now have a role-dependent <a href="https://github.com/bencbartlett/Overmind/blob/master/src/movement/Movement.ts#L32" rel="external nofollow noopener" target="_blank">movement priority</a>, and they will push slower or blocking creeps with lesser move priority out of their way. In general, this results in the two creeps switching locations, but if the blocking creep is performing a task (such as a worker blocking a pathway while sitting in the base fortifying a rampart), it will try to move to a position that is out of the way and still in range of its task target. This allows for some pretty cool behavior like this:</p> <figure> <video src="/assets/video/TrafficManager2_h265.mp4" class="img-fluid rounded z-depth-1" width="auto" height="auto" autoplay="" controls="" loop=""></video> </figure> <p>Even if creeps are able to fluidly move past each other, another complication with bunkers is that groups of creeps clogging the alleyways can result in baby creeps being unable to exit their spawns. This is a particularly pronounced issue with my design, as each spawn has only two exit tiles. To solve this, I implemented a <a href="https://github.com/bencbartlett/Overmind/blob/0ced04b501a74215124c1db2773a379563e8fa6f/src/movement/Movement.ts#L337" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">vacatePos</code></a> method which recursively pushes creeps down alleyways and blocks further movement attempts for that tick to vacate the target position.</p> <h2 id="exceptional-terminal-logic">“Exceptional” terminal logic</h2> <p>Switching base layouts across most of my colonies without evacuating energy and minerals prior to demolition would mean a lot of wasted resources! Fortunately, my terminal network has improved a lot over the last few months, and introducing terminal “<a href="https://github.com/bencbartlett/Overmind/blob/34c1e66b98be9666fe5680e2023ccbefb935fb9c/src/logistics/TerminalNetwork.ts#L339" rel="external nofollow noopener" target="_blank">exception states</a>” to my terminal network was a nice solution to this problem.</p> <p>If everything is functioning normally, the terminal network works by equalizing resource amounts for energy and base minerals between rooms. On top of this, terminals can request resources from the network for boosting or lab production. The highest priority treatment are reserved for terminals which are in exception states. If a terminal is in an exception state (determined by the presence of an <a href="https://github.com/bencbartlett/Overmind/tree/master/src/directives/logistics" rel="external nofollow noopener" target="_blank">appropriate directive</a> at the terminal position), it is removed from the list of terminals which undergo normal operation and is given priority treatment, evacuating and/or requesting resources in decreasing order of value.</p> <p>Exception states have proven to be pretty handy for a variety of uses: the <a href="https://github.com/bencbartlett/Overmind/blob/master/src/directives/logistics/terminalState_emergency.ts" rel="external nofollow noopener" target="_blank">emergency state</a> maintains a constant supply of energy and T3 boosts to fight off enemies during a siege; the <a href="https://github.com/bencbartlett/Overmind/blob/master/src/directives/logistics/terminalState_rebuild.ts" rel="external nofollow noopener" target="_blank">rebuild state</a> evacuates all minerals and keeps a small constant energy supply behind while a room is rebuilding itself; and the <a href="https://github.com/bencbartlett/Overmind/blob/master/src/directives/logistics/terminalState_evacuate.ts" rel="external nofollow noopener" target="_blank">evacuate state</a> is triggered when a room is about to fall after a failed defense, evacuating all resources from the room to prevent them from falling into enemy hands.</p> <h2 id="we-require-more-minerals">We require more minerals!</h2> <p>Overmind <a href="https://github.com/bencbartlett/Overmind/releases/tag/v0.4.0" rel="external nofollow noopener" target="_blank">v0.4</a> finally added long-overdue fully automatic mineral mining, processing, trading, and boosting capabilities. Colonies now automatically start mining minerals once at RCL6. Minerals are transferred between colonies as needed for resource production. Excess minerals are sold on the market, and once a player reaches a credit threshold, missing base minerals required for resource production are purchased from the market. Labs (managed by the <a href="https://github.com/bencbartlett/Overmind/blob/90d05e8d16261ac371af8c3622331a6797c7dd9c/src/hiveClusters/evolutionChamber.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">EvolutionChamber</code></a> object) automatically cycle through reaction queues to build up a stockpile of prioritized resources. Reaction cycles are planned by the <code class="language-plaintext highlighter-rouge">Colony.abathur</code> object, which <a href="https://github.com/bencbartlett/Overmind/blob/34c1e66b98be9666fe5680e2023ccbefb935fb9c/src/resources/Abathur.ts#L172" rel="external nofollow noopener" target="_blank">recursively generates needed reaction queues</a> to produce the highest priority needed compound. When creeps request to get boosted, the necessary resources are transferred to the appropriate colony automatically, or, if the player has sufficient credits, they are be bought on the market if not present.</p> <h2 id="a-skynet-wannabe">A Skynet-wannabe</h2> <p>Overmind <a href="https://github.com/bencbartlett/Overmind/releases/tag/v0.5.0" rel="external nofollow noopener" target="_blank">v0.5</a> is the first release capable of fully automatic operation! One of the biggest challenges in achieving this milestone was figuring out a system to determine approximately optimal base layouts. Fortunately, making the switch to bunkers simplified this process considerably.</p> <p>There are three new modules which facilitate this process. The <a href="https://github.com/bencbartlett/Overmind/blob/c32e360ccbead3b4d4500fdc941f6b8a9297ee92/src/roomPlanner/BasePlanner.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">BasePlanner</code></a> analyzes a room to figure out if and where a bunker can be placed. If there are many possible “anchor” positions, small sample is randomly chosen, and the position with the minimum total path length to points of interest within the room (sources and controller) is returned. The <a href="https://github.com/bencbartlett/Overmind/blob/c32e360ccbead3b4d4500fdc941f6b8a9297ee92/src/strategy/ExpansionPlanner.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">ExpansionPlanner</code></a> looks at a room and a given anchor position (from BasePlanner) and determines a score (roughly, energy per tick) for the room and possible nearby mining outposts. Periodically, the scores for a room are re-computed by the <a href="https://github.com/bencbartlett/Overmind/blob/90d05e8d16261ac371af8c3622331a6797c7dd9c/src/intel/RoomIntel.ts#L1" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">RoomIntel</code></a> module, and the best score to-date and corresponding anchor position is recorded in the room memory. Over time, this results in a semi-optimal choice of bunker placement. Finally, the new <a href="https://github.com/bencbartlett/Overmind/blob/c32e360ccbead3b4d4500fdc941f6b8a9297ee92/src/strategy/Strategist.ts" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">Strategist</code></a> module looks at possible rooms to colonize and chooses the one with the highest score, as long as it is not too close or too far from another colony. (Eventually, the Strategist will be responsible for other high-level decision making, but for now it only does room expansion.)</p> <p>Of course, this system is still quite new and has many improvements that can be made to it, but (even rudimentary) full autonomy a big milestone in the development of my bot.</p> <h2 id="lets-end-on-a-cliffhanger">Let’s end on a cliffhanger</h2> <p>In a previous <a href="https://bencbartlett.wordpress.com/2018/03/12/screeps-3-state-of-the-automated-union/" rel="external nofollow noopener" target="_blank">blog post</a>, I talked about the remaining boxes I wanted to check off before releasing version 1.0 of my bot. At this point, the boxes are all checked (with checkmarks of various messiness), and <strong>the next release will be Overmind v1.0</strong>.</p> <p>So what happens now? Well, there are three major things I want to polish before release.</p> <p>First, I need to restructure parts of the AI to be more CPU efficient. I am currently fairly limited by CPU, as I have been holding out on making some much needed improvements for the devs to release persistent game objects. I’ll likely hold out until the <a href="https://screeps.com/forum/topic/2307/development-updates" rel="external nofollow noopener" target="_blank">promised PTR content</a> in late August, but if persistent game objects aren’t included, I’ll start to develop an emulator for them myself.</p> <p>Second, I want to write proper military code. I do have passable defense and offense code in place already, but my combat code has always lagged behind my economics code. I’ve added a lot of the framework for fully automatic combat over the last few months, including <a href="https://github.com/bencbartlett/Overmind/blob/90d05e8d16261ac371af8c3622331a6797c7dd9c/src/logistics/SpawnGroup.ts" rel="external nofollow noopener" target="_blank">distributed spawning</a> and <a href="https://github.com/bencbartlett/Overmind/blob/90d05e8d16261ac371af8c3622331a6797c7dd9c/src/movement/Movement.ts#L561" rel="external nofollow noopener" target="_blank">combat movement</a>, but I have yet to properly plug it all in.</p> <p>Finally, I have something special that will define the 1.0 release. (You might have heard about it already in the <a href="https://screeps.slack.com/messages/overmind" rel="external nofollow noopener" target="_blank">#overmind</a> Slack channel.) I won’t spoil the surprise yet, but in the words of my favorite Westworld character, “It’s something I’ve been working on for quite some time… Something quite original.”</p> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Ben Bartlett. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>