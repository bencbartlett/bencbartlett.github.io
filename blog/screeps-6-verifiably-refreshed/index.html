<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Screeps #6: Verifiably refreshed | Ben Bartlett</title> <meta name="author" content="Ben Bartlett"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://bencbartlett.github.io/blog/screeps-6-verifiably-refreshed/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Ben </span><span class="font-weight-bold">Bartlett</span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/software/">Software</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Screeps #6: Verifiably refreshed</h1> <p class="post-meta">January 2, 2019</p> <p class="post-tags"> <a href="/blog/2019"> <i class="fas fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/screeps"> <i class="fas fa-hashtag fa-sm"></i> screeps</a>   <a href="/blog/tag/mathematica"> <i class="fas fa-hashtag fa-sm"></i> mathematica</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="assimilation-part-1-verification">Assimilation (part 1): verification</h2> <p>Over the last year, Overmind has gotten quite popular. It is now the dominant open-source bot running on the public servers, especially on <code class="language-plaintext highlighter-rouge">shard2</code>:</p> <p><img src="/assets/img/Screen-Shot-2019-01-02-at-11.34.44-AM.png" alt="" class="img-fluid rounded z-depth-0"></p> <p>Having so many players running my script near me is a cool experience, and it gave me a thematically-fitting direction for Overmind’s final evolution: to become a true universal hivemind by assimilating other players.</p> <p><a href="https://github.com/bencbartlett/Overmind/blob/master/src/assimilation/Assimilator_obfuscated.js" rel="external nofollow noopener" target="_blank">Assimilation</a> is a feature I’ve been teasing for a long time now. It allows all players running Overmind to act as a single, collective entity, sharing creeps and resources between each other and responding jointly to a master ledger of all directives shared by all players. When completed, (my) Overmind will truly be the <a href="https://starcraft.fandom.com/wiki/Overmind" rel="external nofollow noopener" target="_blank">overriding will of the Zerg swarm</a>.</p> <p>Before you get too excited, assimilation is still under construction and far from complete, but I decided to use a portion of this post to talk about an important aspect of it which has already been finished: verifying the codebase.</p> <p>Because of how tightly integrated assimilated players will be, it is possible to modify the codebase to take advantage of the system. Since the codebase is open source, one could modify it to receive resources or combat assistance but never to give them when needed. Since I didn’t want to completely obfuscate the entire codebase, I needed a way to verify the integrity of certain parts of the codebase.</p> <p>Enter the <code class="language-plaintext highlighter-rouge">Assimilator</code>.</p> <p>The Assimilator is a global, persistent object which provides a way of deciding which Overmind players can be mutually trusted. There are a variety of ways it does this, some of which I won’t mention, but I’ll talk about the main verification method here.</p> <p>If you’ve looked around my codebase recently, you’ve probably noticed some <a href="https://github.com/bencbartlett/Overmind/blob/master/src/logistics/TerminalNetwork.ts#L53" rel="external nofollow noopener" target="_blank">parts</a> of the script which are marked with an <a href="https://github.com/bencbartlett/Overmind/blob/master/src/assimilation/decorator.ts" rel="external nofollow noopener" target="_blank">@assimilationLocked</a> decorator. This decorator registers that part of the code with the Assimilator, which ensures that it has not been tampered with. To do this, it exploits a wonderful (horrible?) behavior of Javascript, which is that if <code class="language-plaintext highlighter-rouge">Foo</code> is a class, then <code class="language-plaintext highlighter-rouge">''+Foo</code> evaluates to a string containing the source code for <code class="language-plaintext highlighter-rouge">Foo</code> (!) :</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="nf">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">bar</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">baz</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">''</span> <span class="o">+</span> <span class="nx">Foo</span><span class="p">);</span>
<span class="c1">// &gt; "class Foo {\n    constructor()…z\";\n    }\n\n}"</span>
</code></pre></div></div> <p>The Assimilator uses this behavior to generate a checksum of the @assimilationLocked portions of the script using a <a href="https://github.com/bencbartlett/Overmind/blob/master/src/algorithms/sha256.ts" rel="external nofollow noopener" target="_blank">sha256</a> cryptographic hash. Whenever I deploy code to the main server, a checksum for my version of the code is generated and stored in my memory along with all unique hashes from the last 1 million ticks. If a player is assimilated, then every 1000 ticks, Overmind will send 100 energy to one of my terminals, with a hash of the current codebase as the description. If I receive a checksum which matches that of a recent valid version, I reply on the following tick with a unique clearance key valid for the next 1000 ticks transmitted through public memory:</p> <p><img src="/assets/img/Screen-Shot-2019-01-02-at-12.29.43-PM.png" alt="Screen Shot 2019-01-02 at 12.29.43 PM" class="img-fluid rounded z-depth-0"></p> <p>The assimilator looks at the master ledger of clearance codes to determine which players are trusted. In the future, clearance keys will be used to generate flag names based on the tick they were created. Only flags matching the correct naming pattern will be uploaded to the master ledger of directives shared among the hivemind. This allows players to manually place their own directives which only their creeps will respond to (for fighting their own personal skirmishes), as well as for the Overmind to automatically place directives which all assimilants will see.</p> <h2 id="arefresh-ing-new-architecture">A <code class="language-plaintext highlighter-rouge">refresh</code>-ing new architecture</h2> <p>Prior to some recent changes, Overmind had never been a terribly CPU-efficient bot. A major reason for this is its very hierarchical, object-oriented architecture, which heavily employs classes. Classes are expensive to instantiate, and having many classes with shared references to each other and to game objects makes garbage collection in the V8 engine more expensive than for a flatter, prototype-based architecture.</p> <p>To get a more detailed idea of why this was a problem, let’s look at Overmind’s main loop structure (which I talk about in more detail in a <a href="https://bencbartlett.wordpress.com/2018/01/15/screeps-1-overlord-overload/" rel="external nofollow noopener" target="_blank">previous post</a>). The important bits can be divided into three main (heh) phases:</p> <ol> <li> <code class="language-plaintext highlighter-rouge">build()</code> Recursively instantiate all classes used by the AI. The Overmind object directly instantiates all <a href="https://github.com/bencbartlett/Overmind/blob/master/src/Colony.ts" rel="external nofollow noopener" target="_blank">colonies</a> and <a href="https://github.com/bencbartlett/Overmind/blob/master/src/directives/Directive.ts" rel="external nofollow noopener" target="_blank">directives</a>, which instantiate their <a href="https://github.com/bencbartlett/Overmind/blob/master/src/Colony.ts#L428" rel="external nofollow noopener" target="_blank">hive clusters</a>, <a href="https://github.com/bencbartlett/Overmind/blob/master/src/logistics/LogisticsNetwork.ts" rel="external nofollow noopener" target="_blank">logistics networks</a>, and <a href="https://github.com/bencbartlett/Overmind/blob/master/src/overlords/Overlord.ts" rel="external nofollow noopener" target="_blank">overlords</a>; overlords instantiate their <a href="https://github.com/bencbartlett/Overmind/blob/master/src/zerg/Zerg.ts" rel="external nofollow noopener" target="_blank">Zerg</a> (the wrapper class for creeps), and so on down the tree.</li> <li> <code class="language-plaintext highlighter-rouge">init()</code> Register all requests for actions to be taken this tick, such as <a href="https://github.com/bencbartlett/Overmind/blob/master/src/overlords/Overlord.ts#L310" rel="external nofollow noopener" target="_blank">creep spawning</a>, <a href="https://github.com/bencbartlett/Overmind/blob/master/src/hiveClusters/commandCenter.ts#L108" rel="external nofollow noopener" target="_blank">requesting resources</a>, or <a href="https://github.com/bencbartlett/Overmind/blob/master/src/logistics/RoadLogistics.ts" rel="external nofollow noopener" target="_blank">scheduling road repairs</a>.</li> <li> <code class="language-plaintext highlighter-rouge">run()</code> All state-changing actions happen here: creeps are directed by their overlord, the <a href="https://github.com/bencbartlett/Overmind/blob/master/src/Overseer.ts" rel="external nofollow noopener" target="_blank">Overseer</a> adds and removes directives to respond to the environment, <a href="https://github.com/bencbartlett/Overmind/blob/master/src/logistics/TerminalNetwork.ts" rel="external nofollow noopener" target="_blank">resources are distributed</a> between colonies, <a href="https://github.com/bencbartlett/Overmind/blob/master/src/logistics/TradeNetwork.ts" rel="external nofollow noopener" target="_blank">trades are made</a> with other players, and <a href="https://github.com/bencbartlett/Overmind/blob/master/src/intel/RoomIntel.ts" rel="external nofollow noopener" target="_blank">intel is gathered</a>.</li> </ol> <p>Some heavy profiling revealed that the build phase was using up almost as much CPU as the run phase (and if you include garbage collection time, possibly more)! Clearly this was not optimal…</p> <p>The obvious solution was to make all of the classes persistent, but I had been holding off on doing this for two reasons: (1) much of Overmind’s codebase was written before isolated-VM, so this change would be a major undertaking, and (2) I was hoping that the devs would release persistent game objects, which they had <a href="https://screeps.com/forum/topic/2307/development-updates" rel="external nofollow noopener" target="_blank">teased</a> back in August. However, after a few months waiting for persistent game objects while ignoring the growing elephant in the CPU-constrained room, I decided to just emulate their behavior myself. My solution was to use a set of new caching methods to add a new, alternate phase to the main loop: <code class="language-plaintext highlighter-rouge">refresh()</code>.</p> <p>In the new architecture, every n-th tick (where n=20 by default), the build phase is run, completely re-instantiating all script objects. On all other ticks, refresh() is run instead, updating all references to game objects while keeping existing script class instances alive, allowing for a “soft update” between ticks.  The in-game properties are updated in-place by the <code class="language-plaintext highlighter-rouge">$</code> <a href="https://github.com/bencbartlett/Overmind/blob/master/src/caching/GlobalCache.ts" rel="external nofollow noopener" target="_blank">caching module</a>, which makes for easier garbage collection, and the wonderful generics type safety that TypeScript provides prevents me from doing anything stupid.</p> <p>To get a more concrete idea of how this works, let’s look at an (abridged) example for how <code class="language-plaintext highlighter-rouge">build()</code> and <code class="language-plaintext highlighter-rouge">refresh()</code> work for a hatchery:</p> <script src="https://gist.github.com/bencbartlett/e8f0e92cc8ef7f3601240eb57aaed98d.js"></script> <p>During the build phase, the constructor is called, overwriting the old hatchery object and re-defining properties for all of the structures. Particularly expensive calculations are done with the <code class="language-plaintext highlighter-rouge">$.set()</code> method, which takes a property name and a callback to compute a list of game objects; the callback results are cached to global and assigned to the specified property. During the refresh phase, these properties are updated in-place using the <code class="language-plaintext highlighter-rouge">$.refresh()</code> and <code class="language-plaintext highlighter-rouge">$.refreshRoom()</code> methods. In the global caching module, these methods look like this:</p> <script src="https://gist.github.com/bencbartlett/09406e22a7991a590d2b308f7ac6a0b7.js"></script> <p>This new cache-friendly architecture has been running on the public servers for several months now, and is included in the new <a href="https://github.com/bencbartlett/Overmind/releases" rel="external nofollow noopener" target="_blank">v0.5.1 release</a>. After working a few of the kinks out, I’ve been very happy with its performance: the caching changes have reduced CPU cost by over 40%!</p> <h2 id="brand-advertising">Brand advertising</h2> <p>A while ago, I started rewriting the <a href="https://github.com/bencbartlett/Overmind/blob/master/src/visuals/Visualizer.ts" rel="external nofollow noopener" target="_blank">Visualizer</a> system for Overmind to be better looking, better organized, and to display more useful information. Here’s a screenshot of what it looks like at the moment:</p> <p><img src="/assets/img/Screen-Shot-2018-12-20-at-5.25.45-PM.png" alt="Screen-Shot-2018-12-20-at-5.25.45-PM" class="img-fluid rounded z-depth-0"></p> <p>I generally enjoy writing visualization code, but the part I had the most fun making was efficiently rendering the Overmind logo using room visuals. If you’ve read any of my non-Screeps posts, you probably know that I <a href="https://bencbartlett.wordpress.com/2017/07/11/particle-in-a-fidget-spinner/" rel="external nofollow noopener" target="_blank">really</a> <a href="https://bencbartlett.wordpress.com/2017/07/11/first-blog-post/" rel="external nofollow noopener" target="_blank">like</a> <a href="https://bencbartlett.wordpress.com/2017/07/11/how-to-mathematica-a-practical-guide/" rel="external nofollow noopener" target="_blank">Mathematica</a>. I made a Mathematica notebook to disassemble the logo image into color-quantized components, and used the <a href="https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm" rel="external nofollow noopener" target="_blank">Ramer-Douglas-Peuker algorithm</a> to parameterize the perimeter of each component into a form that <code class="language-plaintext highlighter-rouge">RoomVisual.poly()</code> can accept. This algorithm finds a minimum number of points necessary to outline a shape to within a specified tolerance. The (relatively) small point count means that the logo is actually quite cheap to render – about 1-2 CPU per tick. (And of course, visuals get disabled when the bucket drops below 9000.)</p> <p>If you want to see how I did this, you can see the Mathematica notebook <a href="https://bencbartlett.files.wordpress.com/2018/12/OvermindLogoManipulation.pdf" title="OvermindLogoManipulation" rel="external nofollow noopener" target="_blank">as a PDF</a> or download the notebook source code <a href="https://www.dropbox.com/s/z4ztdzxqss5opqe/OvermindLogoManipulation.nb?dl=1" rel="external nofollow noopener" target="_blank">here</a>.</p> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Ben Bartlett. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>